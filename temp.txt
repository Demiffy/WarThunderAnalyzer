import time
from PIL import Image, ImageOps
import numpy as np
import pytesseract
from pytesseract import TesseractError
import pyautogui

# Define region sizes
REGION_WIDTH = 450
REGION_HEIGHT = 250

BATTLE_REGION_WIDTH = 200
BATTLE_REGION_HEIGHT = 65

GEAR_REGION_WIDTH = 250
GEAR_REGION_HEIGHT = 100

def preprocess_image_for_colors(image):
    np_image = np.array(image)
    red_channel = np_image[:, :, 0]
    green_channel = np_image[:, :, 1]
    blue_channel = np_image[:, :, 2]

    red_mask = (red_channel > 120) & (green_channel < 70) & (blue_channel < 100)
    yellow_green_mask = (red_channel > 190) & (green_channel > 180) & (blue_channel < 60)
    e4ac03_mask = (red_channel > 220) & (green_channel > 160) & (blue_channel < 50)
    mask_90ca03 = (
        (red_channel > 130) & (red_channel < 160) &
        (green_channel > 190) & (green_channel < 220) &
        (blue_channel > 0) & (blue_channel < 50)
    )

    combined_mask = red_mask | yellow_green_mask | e4ac03_mask | mask_90ca03
    filtered_image = np.zeros_like(np_image)
    filtered_image[combined_mask] = [255, 255, 255]
    filtered_image[~combined_mask] = [0, 0, 0]

    processed_image = Image.fromarray(filtered_image).convert("L")
    processed_image = ImageOps.invert(processed_image)
    return processed_image

def fuzzy_contains(text, fragments):
    for fragment in fragments:
        if fragment in text:
            return True
    return False

def analyze_text(extracted_text):
    text = extracted_text.lower()
    events = []

    fire_fragments = ["fire"]
    crew_fragments = ["cre", "kno", "out"]
    crit_fragments = ["crit"]
    hit_fragments = ["hit"]
    ricochet_fragments = ["rico", "rochet"]
    non_penetration_fragments = ["non", "-", "penetrat"]
    explosion_fragments = ["explod"]
    ammo_fragments = ["ammun"]
    fuel_fragments = ["fuel"]

    if fuzzy_contains(text, fire_fragments):
        events.append("Enemy set on fire")
    if fuzzy_contains(text, crew_fragments):
        events.append("Enemy killed, Crew knocked out")
    if fuzzy_contains(text, crit_fragments):
        events.append("Enemy Crit")
    elif fuzzy_contains(text, hit_fragments):
        events.append("Enemy Hit (Most likely not critical)")
    if fuzzy_contains(text, ricochet_fragments):
        events.append("Ricochet occurred")
    if fuzzy_contains(text, non_penetration_fragments):
        events.append("Non-penetration event")
    if fuzzy_contains(text, explosion_fragments):
        if fuzzy_contains(text, ammo_fragments) and fuzzy_contains(text, fuel_fragments):
            events.append("Enemy killed by ammunition and fuel explosion")
        elif fuzzy_contains(text, ammo_fragments):
            events.append("Enemy killed by ammunition explosion")
        elif fuzzy_contains(text, fuel_fragments):
            events.append("Enemy killed by fuel explosion")
        else:
            events.append("Enemy killed by unspecified explosion")

    if not events:
        events.append("No significant events detected in the text")
    return "; ".join(events)

def extract_text_from_image(image):
    processed_image = preprocess_image_for_colors(image)
    try:
        custom_config = r'--oem 3 --psm 6'
        text = pytesseract.image_to_string(processed_image, lang='eng', config=custom_config)
    except TesseractError as e:
        print("Tesseract encountered an error:")
        print(e)
        text = ""
    return text

def extract_battle_text_from_image(image):
    try:
        custom_config = r'--oem 3 --psm 6'
        text = pytesseract.image_to_string(image, lang='eng', config=custom_config)
    except TesseractError as e:
        print("Tesseract encountered an error in battle region:")
        print(e)
        text = ""
    return text

def extract_gear_text_from_image(image):
    try:
        custom_config = r'--oem 3 --psm 6'
        text = pytesseract.image_to_string(image, lang='eng', config=custom_config)
    except TesseractError as e:
        print("Tesseract encountered an error in gear region:")
        print(e)
        text = ""
    return text

if __name__ == "__main__":
    screen_width, screen_height = pyautogui.size()

    # Coordinates for hit/kill detection region
    region_left = screen_width - REGION_WIDTH
    region_top = 0
    region_right = screen_width
    region_bottom = REGION_HEIGHT

    # Coordinates for "To Battle!" detection region
    battle_left = (screen_width - BATTLE_REGION_WIDTH) // 2
    battle_top = 0
    battle_right = battle_left + BATTLE_REGION_WIDTH
    battle_bottom = BATTLE_REGION_HEIGHT

    # Coordinates for gear/speed detection region
    gear_left = 0
    gear_right = GEAR_REGION_WIDTH
    gear_top = screen_height - GEAR_REGION_HEIGHT
    gear_bottom = screen_height

    # Show "To Battle!" region snapshot
    #initial_battle_screenshot = pyautogui.screenshot().crop((battle_left, battle_top, battle_right, battle_bottom))
    #initial_battle_screenshot.show(title="To Battle Region Snapshot")

    # Show gear region snapshot
    #initial_gear_screenshot = pyautogui.screenshot().crop((gear_left, gear_top, gear_right, gear_bottom))
    #initial_gear_screenshot.show(title="Gear Region Snapshot")

    last_battle_time = None

    while True:
        # Check "To Battle!" region
        battle_screenshot = pyautogui.screenshot().crop((battle_left, battle_top, battle_right, battle_bottom))
        battle_text = extract_battle_text_from_image(battle_screenshot).lower()

        if "to battle" in battle_text:
            last_battle_time = time.time()
            print("Detected 'To Battle!' â€” pausing hit/kill detection.")

        current_time = time.time()
        # Decide whether to perform hit/kill detection
        if last_battle_time is None or (current_time - last_battle_time > 10):
            # Check gear/speed region before resuming hit detection
            gear_screenshot = pyautogui.screenshot().crop((gear_left, gear_top, gear_right, gear_bottom))
            gear_text = extract_gear_text_from_image(gear_screenshot).lower()

            gear_fragments = ["gear", "rpm", "spd", "km/h", "n"]

            if fuzzy_contains(gear_text, gear_fragments):
                # Perform hit/kill detection if gear/speed are found
                screenshot = pyautogui.screenshot().crop((region_left, region_top, region_right, region_bottom))
                extracted_text = extract_text_from_image(screenshot)
                print("Detected text in hit/kill region:")
                print(extracted_text)

                result = analyze_text(extracted_text)
                print("Analysis result:")
                print(result)

                if "No significant events detected" not in result:
                    time.sleep(4)
                else:
                    time.sleep(1)
            else:
                print("Gear info not detected, skipping hit/kill detection for now.")
                time.sleep(1)
        else:
            print("Waiting due to recent 'To Battle!' detection...")
            time.sleep(1)